---
title: "Authorial contributions of rOpenSci packages"
author: "Mark Padgham"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: false
        toc_float: false
        number_sections: true
        theme: flatly
        pandoc_args: [
            "--number-offset=1"
                    ]
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  out.width = "100%",
  collapse = TRUE,
  comment = "#>",
  fig.path = "",
  echo = TRUE
)
```


A response to the [call for
help](https://github.com/ropenscilabs/annual-report-help) contributing to the
rOpenSci 2019 Annual Report, via [issue
#4](https://github.com/ropenscilabs/annual-report-help/issues/4), which aimed
to quantify "Number of authors per package". From the original description by [\@sckott](https://github.com/sckott):

> Does the number of maintainers per package change through time?

> In the interest of software sustainability, ideally each package would have
more than one maintainer, but this is relatively rare. We'd like to see the
number of maintainers per package increase over time, but number of maintainers
is hard to address without detailed knowledge of each repo. As a proxy, we
could count up all authors regardless of their role (not counting reviewers,
funders).

> Question becomes: Does the number of authors per package change (increase) through time?

Suggested approaches were based on extracting "official" authors from package
DESCRIPTION files, but numbers of authors in this context are unavoidably
cumulative, and must increase across time because authors are very generally
*not* ever removed once added. Addressing the issue through official
DESCRIPTION files would thus require comparison of these rates of increase with
some kind of neutral, expected value, which seems impracticable, so alternative
approaches are pursued here.

The analyses mostly work via several functions defined in several
`function-*.R` files, loaded here, along with necessary libraries.

```{r libs, message = FALSE}
library (jsonlite)
library (dplyr)
library (magrittr)
library (ggplot2)
source ("functions-repos.R")
source ("functions-extract.R")
source ("functions-analyse.R")
```

The functions mostly use the github graphql API to extract the full commit
histories of all rOpenSci package repos, and of RStudio packages granted the
honour of being listed in their ["official" hex sticker
page](https://github.com/rstudio/hex-stickers/tree/master/PNG). The extraction
of commit histories from the github graphql API requires a client to be
established with the following code:
```{r gh-cli}
token <- Sys.getenv("GITHUB_GRAPHQL_TOKEN") # or whatever
gh_cli <- ghql::GraphqlClient$new (
    url = "https://api.github.com/graphql",
    headers = httr::add_headers (Authorization = paste0 ("Bearer ", token))
)
```

## Get commit histories from github

The objects of this analysis are the entire commit histories (for the default
branch of a repository) of rOpenSci and RStudio repositories. The first
functions obtain all associated repositories as a `data.frame` with columns for
both repository name and associated github organization. The second column is
necessary because not all repositories are directly and respectively hosted on
[`github/ropensci`](https://github.com/ropensci) or
[`github/rstudio`](https://github.com/rstudio). These data are extracted with
the functions, `get_ros_repos()` and `get_rstudio_repos`. Commit histories can
then be extracted by submitting these resultant `data.frame` objects to the
single function, `get_all_commits()`. This function takes about 20 minutes or
so to run for each of rOpenSci and RStudio, so the resultant data are saved to
enable immediate re-loading in all subsequent analyses.

```{r summary-fakey, eval = FALSE, echo = TRUE}
repos <- get_ros_repos ()
system.time (
             dat_ros <- get_all_commits (gh_cli, repos)
             )
names (dat_ros) <- repos
saveRDS (dat_ros, "results-ropensci.Rds")

dat <- get_rstudio_repos ()
system.time (
             dat_rst <- get_all_commits (gh_cli, repos)
             )
names (dat_rst) <- repos
saveRDS (dat_rst, "results-rstudio.Rds")
```

## Proportion of contributions from non-primary contributors

All of the following analyses focus on "non-primary contributors", which are
simply contributors other than the statistically dominant contributor. The
first metric analysed here is the proportion of non-primary contributions, via
the `prop_np_commits()` function.
```{r prop_np_commits}
np_commits_rst <- prop_np_commits (readRDS ("results-rstudio.Rds"))
np_commits_rst$org <- "RStudio"
np_commits_ros <- prop_np_commits (readRDS ("results-ropensci.Rds"))
np_commits_ros$org <- "rOpenSci"
results <- dplyr::bind_rows (np_commits_ros, np_commits_rst)

ggplot (results, aes (date, n)) +
    geom_point (colour = "#9239F6") +
    geom_smooth (colour = "#FF0076", method = "lm") +
    facet_wrap (.~org)
```
RStudio packages clearly have a statistically higher proportion of non-primary
contributions:
```{r prop_np_commits-t-test, echo = FALSE}
tt <- t.test (np_commits_rst$n, np_commits_ros$n)
message ("mean (RStudio) = ", signif (tt$estimate [1], 3),
         "; mean (rOpenSci) = ", signif (tt$estimate [2], 3),
         " [T = ", signif (tt$statistic, 3),
         ", df = ", signif (tt$parameter, 5),
         ", p = ", signif (tt$p.value, 2), "]")
```
```{r prop_np_commits-lm, echo = FALSE}
lm_rst <- summary (lm (np_commits_rst$n ~ np_commits_rst$date))
t_rst <- signif (lm_rst$coefficients [2, 3], 2)
p_rst <- signif (lm_rst$coefficients [2, 4], 2)
lm_ros <- summary (lm (np_commits_ros$n ~ np_commits_ros$date))
t_ros <- signif (lm_ros$coefficients [2, 3], 2)
p_ros <- signif (lm_ros$coefficients [2, 4], 2)
```
The figure also clearly reveals that proportions of non-primary contributions
for RStudio packages have actually decreased between the years 2010 and 2019
(although this decrease was not significant; T = `r t_rst`; p = `r p_rst`). 
There was no significant change for rOpenSci (T = `r t_ros`; p = 
`r p_ros`).

## Effect of package prominence

Packages that are more prominent may attract more non-primary contributions,
and so these results may to some extent merely reflect differences in package
prominence. (We use the term "prominence" here in lieu of "popularity", with
due connotation that prominence is an attribute that can be actively
manipulated; in particular, RStudio has a commercial budget not available to
rOpenSci, and which is able to be directed towards increasing the prominence of
their packages.) Prominence is quantified here by the total number of package
downloads divided by the time elapsed since a package's first release. For
that, we use the [`cranlogs` package](https://cranlogs.r-pkg.org/). Note that
not all rOpenSci packages have been released on CRAN, and so prominence metrics
will only exist for those which have. The extraction of downloads can take
quite some time, so we save the results for subsequent analyses.

```{r cran-downloads, eval = FALSE}
pkgs_rst <- names (readRDS ("results-rstudio.Rds"))
x <- cranlogs::cran_downloads (pkgs_rst, from = "1997-04-01")
saveRDS (x, file = "cran-rstudio.Rds")
pkgs_ros <- names (readRDS ("results-ropensci.Rds"))
x <- cranlogs::cran_downloads (pkgs_ros, from = "1997-04-01")
saveRDS (x, file = "cran-ropensci.Rds")
```
Each of these is a single `data.frame` with columns for `date` (daily values from
the specified `from` date), `count` of daily downloads, and `package` naming
each requested package. The following function then converts these daily
downloads for each package into a single measure of average daily downloads
over the entire lifetime of a package.

```{r process-downloads}
x <- readRDS ("cran-rstudio.Rds")
p_rst <- unlist (lapply (split (x, as.factor (x$package)), function (i) {
                 first <- which (i$count > 0) [1]
                 sum (i$count) / (nrow (i) - first + 1) }))
x <- readRDS ("cran-ropensci.Rds")
p_ros <- unlist (lapply (split (x, as.factor (x$package)), function (i) {
                 first <- which (i$count > 0) [1]
                 sum (i$count) / (nrow (i) - first + 1) }))
```

That of course raises the question of what those "prominence" scores look like?
```{r prominence}
dat_rst <- data.frame (package = names (p_rst),
                       prominence = as.numeric (p_rst),
                       org = "RStudio",
                       stringsAsFactors = FALSE)
dat_ros <- data.frame (package = names (p_ros),
                       prominence = as.numeric (p_ros),
                       org = "rOpenSci",
                       stringsAsFactors = FALSE)
dat <- rbind (dat_rst, dat_ros)
dat$log_prominence <- log10 (dat$prominence)
ggplot (dat, aes (x = org, y = log_prominence, fill = org)) + 
      geom_violin (alpha = 0.7)
```


And perhaps unsurprisingly, RStudio packages are enormously more prominent
that rOpenSci packages (noting that the scale is logarithmic). Does this
prominence affect the proportions of non-primary contributions? For that we
need a single measure of the proportion of commits aggregated over the entire
history of each repo, extracted here with a `quarterly = FALSE` argument.

```{r prom-non-primary}
np_commits_rst <- prop_np_commits (readRDS ("results-rstudio.Rds"), quarterly = FALSE)
np_commits_rst$org <- "RStudio"
np_commits_ros <- prop_np_commits (readRDS ("results-ropensci.Rds"), quarterly = FALSE)
np_commits_ros$org <- "rOpenSci"
np_commits <- dplyr::bind_rows (np_commits_ros, np_commits_rst) %>%
    dplyr::rename (package = repo)

dat <- dplyr::left_join (dat, np_commits, by = c ("package", "org"))
ggplot (dat, aes (x = log_prominence, y = n, colour = org)) +
    geom_point () +
    geom_smooth (method = "lm")
```
```{r prom-non-primary-stats, echo = FALSE}
dat_ros <- dat [dat$org == "rOpenSci", ]
lm_ros <- summary (lm (dat_ros$n ~ dat_ros$log_prominence))
dat_rst <- dat [dat$org == "RStudio", ]
lm_rst <- summary (lm (dat_rst$n ~ dat_rst$log_prominence))

t_rst <- signif (lm_rst$coefficients [2, 3], 2)
p_rst <- signif (lm_rst$coefficients [2, 4], 2)
t_ros <- signif (lm_ros$coefficients [2, 3], 2)
p_ros <- signif (lm_ros$coefficients [2, 4], 2)
```


The two organizations follow categorically different trajectories. More
prominent RStudio packages attract significantly greater proportions of
non-primary contributions (T = `r t_rst`, p = `r p_rst`), 
while more prominent rOpenSci packages tend to attract *lower* proportions of
non-primary contributions, and so become more dominated by singular primary
contributors, although this effect is not significant (T = `r t_ros`, p = 
`r p_ros`).




## Temporal patterns of non-primary contributions

We now delve into more detailed analyses of the git commit histories, through
analysing both numbers of commits and numbers of lines of code committed. We
quantify numbers of distinct contributors, through aggregating numbers of both
commits and lines of code over a defined time period -- fixed at 3 months
throughout all of the following, although could be easily modified -- and
grouping by unique contributor. Contributions from the primary contributor are
removed from the analysis, so as only to count contributions from additional
people other than the primary author. The numbers are then converted to relative
amounts for each time period, sorted in decreasing order, and then converted to
a linear rate of decrease per additional unique contributor. This metric is
derived for each package for each quarter in which sufficient data are
available. Ordered contributions should generally decrease, but *lower* rates
of decrease are taken here to imply greater proportions of non-primary
contributors. The metrics examined throughout the following are thus all
negative slopes, with values approaching zero indicating greater proportions of
non-primary contributions.

```{r authors-per-time-interval}
dat <- readRDS ("results-rstudio.Rds")
commits_rst <- stats_commits (dat)
lines_rst <- stats_lines (dat)
np_commits_rst <- prop_np_commits (dat)
dat <- readRDS ("results-ropensci.Rds")
commits_ros <- stats_commits (dat)
lines_ros <- stats_lines (dat)
np_commits_ros <- prop_np_commits (dat)

commits_rst$org <- "RStudio"
lines_rst$org <- "RStudio"
commits_ros$org <- "rOpenSci"
lines_ros$org <- "rOpenSci"

mean (commits_ros$slope, na.rm = TRUE); mean (commits_rst$slope, na.rm = TRUE)
mean (lines_ros$slope, na.rm = TRUE); mean (lines_rst$slope, na.rm = TRUE)

results <- rbind (commits_rst,
                  commits_ros,
                  lines_rst,
                  lines_ros) %>%
    dplyr::filter (!is.na (slope))

ggplot (results, aes (date, slope)) +
    geom_point (colour = "#9239F6") +
    geom_smooth (colour = "#FF0076", method = "lm") +
    facet_wrap (.~var + org)
```

Non-primary contributions in terms of both commits and lines of code have thus
increased over time in both organizations, with values being clearly higher for
RStudio than rOpenSci.
